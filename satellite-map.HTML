<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Radar Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    html, body { margin: 0; height: 100%; width: 100%; }
    #map { height: 100%; width: 100%; }
    .overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 12px;
      font-family: sans-serif;
      font-size: 14px;
      border-radius: 6px;
      z-index: 1;
      max-width: 220px;
    }
    .overlay label {
      display: block;
      margin: 6px 0;
      cursor: pointer;
    }

    .overlay input[type="checkbox"] {
      margin-right: 8px;
    }
    .maplibregl-popup-content {
      display: flex;
      flex-direction: column;
      background: #373434;
      color: ivory;
    }
    .maplibregl-popup-close-button {
      color: white;
    }
    strong {
      color: #0093ff;
      text-decoration: underline;
      text-align:center;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="overlay">
  <strong>Weather Layers</strong><br>
  <label><input type="checkbox" id="precipitation" checked> Precipitation</label>
  <label><input type="checkbox" id="clouds" > Clouds</label>
  <label><input type="checkbox" id="temp" > Temperature</label>
  <label><input type="checkbox" id="wind" > Wind</label>
  <label><input type="checkbox" id="pressure"> Pressure</label>
  <label><input type="checkbox" id="earthquakes" > Earthquakes (M2.5+ last 7 days)</label>
  <br>
  <small>Scroll: Zoom | Right-click+drag: Rotate | Shift+drag: Pitch</small>
</div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<script>
  const API_KEY = '34d38878aa95ce19e71e8d7f39755a25'; // â† replace with your OpenWeatherMap key
const weatherLayers = {
  precipitation: { name: 'precipitation_new', opacity: 1 },
  clouds: { name: 'clouds_new', opacity: 1 },
  temp: { name: 'temp_new', opacity: 1 },
  wind: { name: 'wind_new', opacity: 1 },
  pressure: { name: 'pressure_new', opacity: 1}
};

const map = new maplibregl.Map({
  container: 'map',
  center: [-98.5, 39.5],
  zoom: 4,
  pitch: 0,
  bearing: 0,
  hash: true,
  maxZoom: 18,
  maxPitch: 85,
  style: {
    version: 8,
    sources: {
      osm: {
        type: 'raster',
        tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: 'Â© OpenStreetMap contributors'
      },
      openfreemap: {
        type: 'vector',
        url: 'https://tiles.openfreemap.org/planet'
      }
    },
    layers: [
      {
        id: 'osm',
        type: 'raster',
        source: 'osm'
      }
    ]
  }
});

map.addControl(
  new maplibregl.NavigationControl({
    visualizePitch: true,
    showZoom: true,
    showCompass: true
  })
);

map.on('load', () => {
  const popup = new maplibregl.Popup({
  closeButton: true,
  closeOnClick: true
});

map.on('click', async (e) => {
  const features = map.queryRenderedFeatures(e.point, {layers: ['earthquakes-layer']});
  if (features.length > 0) {
    return;
  }
  const { lng, lat } = e.lngLat;

  try {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=imperial&appid=${API_KEY}`
    );

    if (!response.ok) throw new Error('Weather request failed');

    const data = await response.json();

    const temp = Math.round(data.main.temp);
    const feels = Math.round(data.main.feels_like);
    const wind = Math.round(data.wind.speed);
    const windDir = data.wind.deg ?? 'â€“';
    const pressure = data.main.pressure;
    const humidity = data.main.humidity;
    const clouds = data.clouds.all;

    popup
      .setLngLat([lng, lat])
      .setHTML(`
        <strong>Weather at location</strong>
        ğŸŒ¡ Temp: ${temp} Â°F<br>
        ğŸ¤” Feels like: ${feels} Â°F<br>
        ğŸ’¨ Wind: ${wind} mph (${windDir}Â°)<br>
        ğŸ§­ Pressure: ${pressure} hPa<br>
        ğŸ’§ Humidity: ${humidity}%<br>
        â˜ï¸ Clouds: ${clouds}%
      `)
      .addTo(map);

  } catch (err) {
    popup
      .setLngLat([lng, lat])
      .setHTML('<strong>Weather data unavailable</strong>')
      .addTo(map);

    console.error(err);
  }
});

map.setPaintProperty('osm', 'raster-brightness-min', 0.15);
map.setPaintProperty('osm', 'raster-brightness-max', 0.85);
map.setPaintProperty('osm', 'raster-contrast', 0);
map.setPaintProperty('osm', 'raster-saturation', 0);
  /* ============================
     3D BUILDINGS
  ============================ */
  map.addLayer({
    id: '3d-buildings',
    type: 'fill-extrusion',
    source: 'openfreemap',
    'source-layer': 'building',
    minzoom: 15,
    filter: ['!=', ['get', 'hide_3d'], true],
    paint: {
      'fill-extrusion-color': [
        'interpolate',
        ['linear'],
        ['get', 'render_height'],
        0, 'lightgray',
        200, 'royalblue',
        400, 'lightblue'
      ],
      'fill-extrusion-height': [
        'interpolate',
        ['linear'],
        ['zoom'],
        15, 0,
        16, ['get', 'render_height']
      ],
      'fill-extrusion-base': [
        'interpolate',
        ['linear'],
        ['zoom'],
        15, 0,
        16, ['get', 'render_min_height']
      ],
      'fill-extrusion-opacity': 0.8
    }
  });

  /* ============================
     WEATHER LAYERS
  ============================ */
  Object.entries(weatherLayers).forEach(([key, layer]) => {

    map.addSource(`${key}-source`, {
      type: 'raster',
      tiles: [
        `https://tile.openweathermap.org/map/${layer.name}/{z}/{x}/{y}.png?appid=${API_KEY}`
      ],
      tileSize: 256
    });

    const paint = {
      'raster-opacity': 0,
      'raster-fade-duration': 0
    };

    if (key === 'clouds') {
      paint['raster-hue-rotate'] = 0;
      paint['raster-saturation'] = -0.6;
      paint['raster-contrast'] = .5;
      paint['raster-brightness-min'] = 0.25;
      paint['raster-brightness-max'] = .85;
    }

    if (key === 'precipitation') {
      paint['raster-hue-rotate'] = 0;
      paint['raster-saturation'] = .2;
      paint['raster-contrast'] = .2;
    }

    if (key === 'temp') {
      paint['raster-saturation'] = 0.2;
      paint['raster-contrast'] = 0.2;
    }

    if (key === 'wind') {
      paint['raster-contrast'] = .2;
    }

    map.addLayer(
      {
        id: `${key}-layer`,
        type: 'raster',
        source: `${key}-source`,
        paint,
        layout: { visibility: 'none' }
      },
      '3d-buildings'
    );
    // Earthquakes source (remote GeoJSON)
if (!map.getSource('earthquakes')) {
  map.addSource('earthquakes', {
    type: 'geojson',
    data: 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojson'
  });
}

// Earthquakes layer - circles styled by mag (size) and depth (color)
if (!map.getLayer('earthquakes-layer')) {
  map.addLayer({
  id: 'earthquakes-layer',
  type: 'circle',
  source: 'earthquakes',
  paint: {
    'circle-radius': [
      'interpolate',
      ['linear'],
      ['get', 'mag'],
      2.5, 8,
      4, 12,
      6, 16
    ],
'circle-color': [
  'interpolate',
  ['linear'],
  ['get', 'mag'],
  2.5, 'green',  // green for small
  4.0, '#ffff00',  // yellow
  5.0, '#ffa500',  // orane
  6.0, '#ff0000'   // red for strong
],
    'circle-opacity': 0.9,
    'circle-stroke-width': 2,
    'circle-stroke-color': '#ffffff'
  },
  layout: {
    'visibility': 'visible'  // matches checkbox "checked"
  }
});
}

// Click popup with useful info
map.on('click', 'earthquakes-layer', (e) => {
  if (!e.features.length) return;
  const feature = e.features[0];
  const props = feature.properties;
  const coords = feature.geometry.coordinates;
  const time = new Date(props.time).toLocaleString();

  const html = `
    <h3>${props.title || 'Earthquake'}</h3>
    <p><strong>Magnitude:</strong> ${props.mag}</p>
    <p><strong>Time:</strong> ${time}</p>
    <p><strong>Location:</strong> ${props.place}</p>
    <a href="${props.url}" target="_blank">USGS Details â†’</a>
  `;

popup
    .setLngLat(e.lngLat)
    .setHTML(html)
    .addTo(map);
});

// Cursor pointer on hover
map.on('mouseenter', 'earthquakes-layer', () => { map.getCanvas().style.cursor = 'pointer'; });
map.on('mouseleave', 'earthquakes-layer', () => { map.getCanvas().style.cursor = ''; });

// Auto-refresh data every 1 minute
setInterval(() => {
  const source = map.getSource('earthquakes');
  if (source) {
    source.setData('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojson');
  }
}, 60000);
  });

  /* ============================
     TOGGLE HANDLER
  ============================ */
function toggleLayer(layerId, visible) {
  if (layerId === 'earthquakes') {
    const visibility = visible ? 'visible' : 'none';
    map.setLayoutProperty('earthquakes-layer', 'visibility', visibility);

  } else {
    // Existing raster weather layers
    const visibility = visible ? 'visible' : 'none';
    map.setLayoutProperty(`${layerId}-layer`, 'visibility', visibility);
    map.setPaintProperty(`${layerId}-layer`, 'raster-opacity', visible ? weatherLayers[layerId].opacity : 0);
  }
}
/* ====================
     INITIAL CHECKBOX STATE
  ============================ */
  document
    .querySelectorAll('.overlay input[type="checkbox"]')
    .forEach(cb => {
      toggleLayer(cb.id, cb.checked);
      cb.addEventListener('change', () => toggleLayer(cb.id, cb.checked));
    });

});
</script>
</body>
</html>